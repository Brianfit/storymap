<!DOCTYPE HTML>
<html>
  <head>
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Mister Fox's Instant Story Mapping Gizmo</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/alertify.core.css" />
    <link rel="stylesheet" href="css/alertify.default.css" />
    <style>
      body {
        margin: 0px;
        padding: 0px;
        background-color: white;
        
      }

    </style>
  </head>
  <body>

   <div class="container" style="background-color: white;">
  <div class="imageframe">
  <div id="result" class="resultstyle text-center"></div></div>
<!-- The first row is the picture: full size.  -->
   <div class="row">
<div id = "storymapimage" class = "col-md-12">


<!-- Let's define our canvas. --> 
    <canvas id="myCanvas" width="1200" height="800"></canvas>
    
    
    <script>
      var canvas = document.getElementById('myCanvas');
      var context = canvas.getContext('2d');
      
//       The default values texts for the story map get loaded here.
      var broken = "The Broken Land"; 
      var hero = "The Hero";
      var gift = "The Gift";
      var mentor = "The Mentor";
      var monster = "The Monster";
      var vision = "The Vision";
      var value1 = "Values";
      var value2 = "Values";
      var value3 = "Values";
      var moral = "The Moral of the story.";
      var storyname = "The Hero's Journey";
    

      var wrapit = false;
// wrapit gets set true if a text is longer than its allotted space      
	  
//Let's load the image and position labels over it	  
      var imageObj = new Image();

      imageObj.onload = function() {
        context.drawImage(imageObj, 0, 0);
        context.font = '10pt Arial';
context.fillStyle = 'darkgrey';
context.fillText(storyname,500,75);
context.fillText(broken, 100, 450);
context.fillText(hero, 400, 200);
context.fillText(gift, 525, 125);
context.fillText(mentor, 650, 200);
context.fillText(monster, 900, 375);
context.fillText(vision, 900, 450);
context.fillText(value1, 550, 525);
context.fillText(value2, 550, 550);
context.fillText(value3, 550, 575);
wrapText(context, moral, 500, 600, 300, 25);

      };
      imageObj.src = 'storymapblank.png';
      
      
// The reload function reloads the picture and assigns labels to the form results  
    
     var reload = function(){
     storyname = story.storyname.value;
     broken = story.broken.value;
     hero = story.hero.value;
     gift = story.gift.value;
     mentor = story.mentor.value;
     monster = story.monster.value;
     vision = story.vision.value;
     value1 = story.value1.value;
     value2 = story.value2.value;
     value3 = story.value3.value;
     moral = story.moral.value;
     
     context.clearRect(0, 0, canvas.width, canvas.height);
     
        context.drawImage(imageObj, 0, 0);
        context.font = '12pt Arial';
context.fillStyle = 'black';

// The textRender function takes text, X position, y Position, maximum width and determines if the text is wider than its maximum allowed width. It then writes the text to coordinatex X, Y, as is if it's not too long, wrapped if it is. 

var width = context.measureText(storyname).width;
var centerx = 545 - (width / 2);
console.log(centerx);  
ChangeFont('14','darkblue');
textRender("Story",storyname,centerx,75,800);
ChangeFont('12','black');
textRender("Broken World",broken,5,525,150);
textRender("Hero",hero,275,200,150);
textRender("Gift",gift,525,125,150);
textRender("Mentor",mentor,675,200,150);
textRender("The Monster",monster,925,375,150);
textRender("The Vision",vision,950,525,150);
// Sorry, values have to be one word. Don't even test for wrap.


     var fieldTest1 = $.trim(value1);
          var fieldTest2 = $.trim(value2);
               var fieldTest3 = $.trim(value3);
     if (fieldTest1 !== '' || fieldTest2 !== '' || fieldTest3 !== '')
     {
     
context.fillText('Values:',525,525);
context.fillText(value1, 525, 550);
context.fillText(value2, 525, 575);
context.fillText(value3, 525, 600);}
// context.fillText(moral, 450, 600);
//The Moral is always going to be long so don't test, just wrap, right?
ChangeFont('12','black');
// wrapText(context, 'Moral: '+moral, 425, 600, 300, 25);
var width = context.measureText(moral).width;
var centerx = 545 - (width / 2);
textRender('Moral: ',moral,centerx,700,1000);
//         screenshot();

      }; 
      
     var textRender = function(label,fieldname, x, y, widthmax){
     var fieldTest = $.trim(fieldname);
     console.log(fieldTest);
     if (fieldTest !== '') {
     fieldname = label+': '+fieldname}
     measure(fieldname,widthmax); 
     if (wrapit = false) {context.fillText(fieldname, x, y);}
else {wrapText(context,fieldname,x, y, widthmax, 18);}
      }
      
     var measure = function(testtext,maxwide) {
     var width = context.measureText(testtext).width;
     if (width > maxwide) wrapit = true; 
     } 
      
function wrapText(context, text, x, y, maxWidth, lineHeight) {
        wrapit = false;
//         We reset wrapit to its default false value here so subsequent measures are valid
        var words = text.split(' ');
        var line = '';
        
                   
        for(var n = 0; n < words.length; n++) {
          var testLine = line + words[n] + ' ';
          var metrics = context.measureText(testLine);          
          var testWidth = metrics.width;

          	if (testWidth > maxWidth && n > 0) {           
            context.fillText(line, x, y);
            line = words[n] + ' ';
            y += lineHeight;
          }
          else {
            line = testLine;
          }
        }
        context.fillText(line, x, y);
        console.log('Writing '+line+' at '+x);
      }
      
var ChangeFont = function(size, colorshift) {

context.font = size+'pt Arial';
context.fillStyle = colorshift;


}     

var screenshot = function(){
// $('#result').append('<p style="text-center">');
// html2canvas(document.getElementById('storymapimage'), {
//   onrendered: function(canvas) {
//     document.body.appendChild(canvas);
// document.getElementById("result").appendChild(canvas);

javascript:void(window.open().location = document.getElementsByTagName("canvas")[0].toDataURL("image/‌​png"))

// $('#result').append('<hr />Right click the image above to download<hr />');
//   },
  
// };
// window.alert("Here's your story map image. Right click to download");
// var myElement = document.querySelector("#result");
// myElement.style.backgroundColor = "#D93600";
// myElement.style.margin = "0 auto";
// reduceImage()

}      

// var reduceImage = function(){
// $('#result').contents().find('img').attr('width', '200px');
// }
    </script>      

    
    </div>
          <button type="button" class="btn btn-secondary pull-right" onclick="screenshot()">Take Screenshot</button>
    </div>
<div class="row">    
       <div class="col-md-4"></div>

    <div class="col-md-4">
    <form name="story" action="javascript:reload()" class="form-signin" method="get">
  Story Name: <input type="text" class="form-control" name="storyname"><br>  
  The Broken Land: <input type="text" class="form-control" name="broken"><br>
  The Hero: <input type="text" class="form-control" name="hero"><br>
  The Gift: <input type="text" class="form-control" name="gift"><br>
  The Mentor: <input type="text" class="form-control" name="mentor"><br>
  The Monster: <input type="text" class="form-control" name="monster"><br>
  The Vision: <input type="text" class="form-control" name="vision"><br>
  The Values: <input type="text" class="form-control" name="value1"><br>
  The Values: <input type="text" class="form-control" name="value2"><br>
  The Values: <input type="text" class="form-control" name="value3"><br>
  The Moral: <input type="text" class="form-control" name="moral"><br>
  <input type="submit" value="Submit">
</form>
</div>
   <div class="col-md-4"></div>
</div>
</div> <!-- container -->

    <script src="js/jquery.min.js"></script>
     <script src="js/html2canvas.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
    <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-72802777-1', 'auto');
  ga('send', 'pageview');

</script>
 <script src='js/alertify.min.js'></script>
 
 <script>alertify.alert("Welcome to Mister Fox's Story Mapping gizmo. This is The Hero's Journey, one of the most common story arcs in the world and one which can be useful for <strong>creating a simple schematic to explain an activist campaign to fundraisers, communicators, and political operatives</strong>. If everyone understands the monster you're fighting, the values you're expressing, the moral you're working towards, the broken world you're trying to fix, the vision of a healed world you're trying to deliver, and the hero that's going to deliver it, you can simplify many of the routine tasks of running a campaign and present a more consistent and effective public profile.<br /><br /><strong>Instructions:</strong> Fill out the fields below the image with your story's elements. When you click 'Submit' the fields will appear in the image. All done? Click the 'Take Snapshot' button to generate an image you can download.<br /><br /><br /><br /><span style='font-size:x-small'><a href=''><img src='cc-by-nc-sa.png' width='40' height='14'> Brought to you by Dancing Fox. Fork this open source code on GitHub</a></span>");</script>
  </body>
</html>  